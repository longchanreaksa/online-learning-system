{% extends "base.html" %}

{% block title %}Student Dashboard - {{ block.super }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% if user.student_profile.profile_photo %}
                            <img src="{{ user.student_profile.profile_photo.url }}" 
                                class="rounded-circle img-thumbnail" 
                                width="150" 
                                height="150"
                                alt="Profile Photo">
                        {% else %}
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                style="width: 150px; height: 150px; margin: 0 auto;">
                                <i class="bi bi-person-fill text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <h5 class="card-title">{{ user.get_full_name|default:user.username }}</h5>
                    <p class="text-muted mb-1">Student</p>
                    <p class="text-muted small">
                        <i class="bi bi-envelope me-1"></i> {{ user.email }}
                    </p>
                    
                    <hr>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'users:profile' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil-square me-1"></i> Edit Profile
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">Your Progress</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Courses Enrolled</span>
                        <span class="badge bg-primary rounded-pill">{{ enrollments.count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Completed</span>
                        <span class="badge bg-success rounded-pill">{{ completed_courses }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>In Progress</span>
                        <span class="badge bg-warning rounded-pill">{{ in_progress_courses }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Welcome Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="card-title mb-1">Welcome back, {{ user.first_name|default:"Student" }}!</h4>
                            <p class="text-muted mb-0">Here's what's happening with your courses</p>
                        </div>
                        <a href="{% url 'courses:course_list' %}" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i> Find Courses
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Current Courses -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">My Courses</h5>
                </div>
                <div class="card-body">
                    {% if enrollments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Progress</th>
                                        <th>Last Accessed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for enrollment in enrollments %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'courses:course_detail' enrollment.course.slug %}" 
                                            class="text-decoration-none">
                                            <strong>{{ enrollment.course.title }}</strong>
                                            </a>
                                            <div class="text-muted small">
                                                {{ enrollment.course.instructor.user.get_full_name }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success" 
                                                    role="progressbar" 
                                                    style="width: {{ enrollment.progress_percentage }}%" 
                                                    aria-valuenow="{{ enrollment.progress_percentage }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {{ enrollment.completed_lessons }}/{{ enrollment.total_lessons }} lessons
                                                ({{ enrollment.progress_percentage }}%)
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ enrollment.last_accessed|date:"M d, Y"|default:"Never" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No Courses Yet</h5>
                            <p class="text-muted">You haven't enrolled in any courses yet</p>
                            <a href="{% url 'courses:course_list' %}" class="btn btn-primary mt-2">
                                Browse Available Courses
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tooltip initialization
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Mark course as accessed
    const courseLinks = document.querySelectorAll('.course-link');
    courseLinks.forEach(link => {
        link.addEventListener('click', function() {
            const courseId = this.dataset.courseId;
            // You would typically make an AJAX call here to update last accessed
            // fetch(`/api/courses/${courseId}/mark-accessed/`, { method: 'POST' });
        });
    });
});
</script>
{% endblock %}